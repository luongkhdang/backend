# Plan: Improve JSON Parsing Robustness in Step 3

**Goal:** Enhance the entity extraction process (Step 3) to handle potentially malformed JSON responses from the Gemini API more gracefully, reducing failures and improving error diagnostics.

**Target Files:**

- `src/steps/step3/__init__.py` (Primary implementation location)
- `requirements.txt` (Add `json5` dependency)

**Implementation Steps:**

1.  **Add `json5` Dependency:**

    - Add `json5` to the `requirements.txt` file. Specify a stable version (e.g., `json5>=0.9.6`).
    - Rebuild the Docker image base (`article-transfer-base`) or the main image (`article-transfer-app`) to include the new dependency.

2.  **Create Robust JSON Parsing Helper Function:**

    - Define a new private helper function `_parse_json_robustly` within `src/steps/step3/__init__.py`.
    - **Function Signature:**
      ```python
      async def _parse_json_robustly(json_string: str, model_name: str, article_id: Optional[int] = None) -> Optional[Dict[str, Any]]:
      ```
    - **Logic:**
      - Attempt standard `json.loads(json_string.strip())`. Return the result if successful.
      - If `json.JSONDecodeError` occurs:
        - Log a warning including the specific error message (`json_err`), the model name, the article ID (if available), and context around the error position (`json_err.pos`) from the `json_string`. (e.g., 30 characters before and after).
        - Attempt to import `json5`. Log a warning if not available.
        - If `json5` is available, attempt `json5.loads(json_string.strip())`.
        - If `json5.loads` succeeds, log an info message indicating success with the fallback parser and return the result.
        - If `json5.loads` also fails, log a final error message including the `json5` error and return `None`.
      - If any other exception occurs during parsing, log it as an error and return `None`.

3.  **Integrate Helper Function into Step 3:**

    - Locate the section in `src/steps/step3/__init__.py` where the raw text response from the Gemini API (specifically for entity extraction) is currently processed and parsed (likely after the `task_manager.run_tasks` call within the main `run` function, when iterating through `extraction_results`).
    - Modify this section to:
      - Extract the raw text content from the Gemini response (handling potential markdown fences `json ... ` if necessary, although the robust parser might handle this).
      - Call `await _parse_json_robustly(raw_text, model_name, article_id)` instead of directly using `json.loads`.
      - Store the result (either the parsed dictionary or `None`) back into the `extraction_results` structure or handle it directly.

4.  **Update Result Handling:**
    - Ensure the subsequent code (e.g., in `_store_results`) correctly handles cases where the parsing result for an article is `None`. It should treat this as a processing error for that specific article (e.g., log a warning, increment error count, skip storing entities for that article, but potentially still mark it processed if appropriate).

**Rationale:**

- **Targeted Fix:** Addresses the JSON parsing issue specifically where it occurs (Step 3 entity extraction) without modifying the generic `GeminiClient`.
- **Sophistication vs. Complexity:** Uses `json5` for robust parsing of common errors (like trailing commas) without needing complex, potentially brittle custom repair logic.
- **Improved Debugging:** Enhanced error logging provides context around parsing failures, making it easier to identify the exact issue in the model's output.
- **Maintainability:** Encapsulates the parsing logic in a dedicated helper function.

**Verification:**

- Run Step 3 and monitor logs for:
  - Successful parsing messages (both standard and `json5` fallback).
  - Detailed error messages when parsing fails even with `json5`.
  - Correct handling of parsing failures in the `_store_results` function.
